<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



    <link rel="stylesheet" href="../node_modules/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css">


    <title>Document</title>
</head>

<body>

    <style>
        body{
            background-color: antiquewhite;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart2 {
            width: 340px;
            /* border: solid red 1px; */
            display: flex;
            justify-self: flex-start;

        }

        .logo-opie {
            display: flex;
            justify-content: space-around;
            align-items: center;
            



        }
        .titre{
            width: 70%;    
            border-radius: 15px;   
            background-color: rgb(107, 197, 137); 
            padding: 5px;
            max-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            
            
        }
        h3{
            text-align: center;
        }
        .texte{
                width: 90%;
                margin: auto;
                margin-top: 1rem;
                border-radius: 15px;
                padding: 20px;
                background-color: rgb(241, 188, 39);
            }
        
        


        #map {
            /* border: solid red 1px; */
            width: 500px;
            height: 500px;
            margin-top: 5rem;
            margin-bottom: 2rem;
        }

        #map .leaflet-pane {
            background-color: pink;
        }


        @media screen and (min-width: 801px) {
            .texte{
                text-align: center;
                width: 70%;
                font-size: 18px;
                background-color: rgb(223, 209, 191);
            }
            ol{
                display: none;
            }

        }
        @media screen and (max-width: 800px) {
            .container {
                flex-direction: column;
            }

            .chart {
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .chart2 {
                width: 300px;
            }

            #map {
                width: 90%;
            }

            .logo-opie img {
                width: 50px;
            }
          
            p{
                font-size: 18px;
            }

        }
    </style>

    <div class="logo-opie">
        <a href="https://atlas-odonates.insectes.org/">
            <img src="./images/logo.svg" />

        </a>
        <div class="titre">
            <h3>exercice création d'une carte et graphique</h3>
        </div>
    </div>

    <div class="texte">
        <p>
            j'ai improvisé une carte et un graphique avec des données imaginaires issues d'un fichier json. j'ai  lié ce fichier à la carte et au graphique. </p>
           <p>Quand le fichier de données est modifié alors la carte et la graphique se modifient.
        </p>
        <ol>
            <li>leaflet.js</li>
            <li>chartJs</li>
        </ol>
        <div>
            <a href="https://github.com/cundovar/leaflet-chartjsEXOcarteGraph">voir le code</a>
        </div>
    </div>

    <div class="container ">


        <div id="map"></div>
        <div class="chart">
            <div class="chart2">

                <canvas id="monGraph" width="400" height="300"></canvas>
            </div>
        </div>
    </div>



    <script>

        var map = L.map("map", {
            maxBounds: L.latLngBounds(
                L.latLng(41.28, -5.7), // Sud-Ouest de la France
                L.latLng(51.06, 10.5) // Nord-Est de la France
            ),
            maxBoundsViscosity: 0.9, // Empêche le glissement des limites maximales
        }).setView([46.7111, 1.7191], 6);

        L.esri.basemapLayer("Gray").addTo(map);

        fetch("insect_data.json")
            .then((response) => response.json())
            .then((data) => {
                // Créer une couche de cercles pour chaque maille
                var insectLayer = L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        // var radius = feature.properties.insectCount * 2; // taille du cercle en fonction du nombre d'insectes
                        var color = getColor(feature.properties.insectCount); // couleur du cercle en fonction du nombre d'insectes
                        return L.circleMarker(latlng, {
                            //   radius: radius,
                            fillColor: color,
                            fillOpacity: 0.7,
                            color: "#000",
                            weight: 1,
                        });
                    },
                });

                // Ajouter la couche de cercles à la carte
                insectLayer.addTo(map);

                // Ajouter un contrôle de couches à la carte
                var overlayMaps = {
                    "Insectes par maille": insectLayer,
                };
                L.control.layers(null, overlayMaps).addTo(map);
            });

        function getColor(d) {
            return d > 100
                ? "#800026"
                : d > 20
                    ? "#E31A1C"
                    : d > 5
                        ? "#FC4E2A"
                        : d > 1
                            ? "#FD8D3C"

                            : "";
        }

        // ****** chart.js********


        // récupère context du canvas
        fetch("insect_data.json")
            .then((response) => response.json())
            .then((data) => {
                // Filtrer les features selon les insectCount
                let featuresBelow5 = data.features.filter((feature) => feature.properties.insectCount < 5);
                let featuresBelow20 = data.features.filter((feature) => feature.properties.insectCount >= 5 && feature.properties.insectCount < 20);
                let featuresBelow50 = data.features.filter((feature) => feature.properties.insectCount >= 20 && feature.properties.insectCount < 50);
                let featuresAbove100 = data.features.filter((feature) => feature.properties.insectCount >= 100);

                // Création des labels, valeurs et couleurs pour le graphique
                let labels = ["nombre insectes < 5", "nombre insectes < 20", "nombre insectes < 50", "nombre insectes > 100"];
                let values = [featuresBelow5.length, featuresBelow20.length, featuresBelow50.length, featuresAbove100.length];
                let colors = ["#FD8D3C", "#FC4E2A", "#E31A1C", "#800026"];


                let legendPosition = "top"; // position par défaut
                if (window.innerWidth < 768) {
                    // écran mobile
                    legendPosition = 'chartArea';
                }

                // Création du graphique avec Chart.js
                let ctx = document.querySelector("#monGraph");
                let graph = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Nombre d'insectes",
                                data: values,
                                backgroundColor: colors,
                            },
                        ],
                    },
                    options: {
                        legend: {
                            position: legendPosition,
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10,
                                radius: 10,
                                // textAlign: "right",
                            }
                        },
                    },
                });
            });

    </script>





    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>


    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>


    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"
        integrity="sha512-i9mZ/0lnBMdKZjkVQXImtZbWzrhomyyQzXarfT4ki1eD/Bi+rcV4lFyzX52lbRQtqj070JQea4p8QNCMrHzuYg=="
        crossorigin=""></script>

    <script src="./js.js" />



    <script
        src="https://unpkg.com/chartjs-plugin-legend-circular@0.1.6/dist/chartjs-plugin-legend-circular.min.js"></script>
</body>

</html>